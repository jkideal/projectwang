# **Canal-client的es同步解决方案**

### **方案选用原因**

因公司产品研发部门房产项目的spring版本为3.1.3release 相对匹配spring data elasticsearch的版本同样很低 并且elasticsearch的版本兼容要求很高 因此对应elasticsearch版本相应会很低，但是我们采用的canal1.1.3框架兼容elasticsearch版本为6.2.3（canal最低兼容elasticsearch版本也是6.X）因此在这种冲突下不采用房产业务部项目直接对接elasticsearch服务，采用中间服务，以http请求的方式调用服务接口完成操作，同时canal-client自定义多表查询也可以同样在这个服务中使用。本服务即中间服务。
### **方案具体需求**
1. 提供对房产部门的es查询接口
2. SpringBoot 启动同时启动canal适配器接收mariaDB数据修改推送
3. canal同步更新多表结果集数据到es
#### **es查询接口**
1. 这部分需要产研部门按照需求书写或者书写通用接口 测试完毕
#### **canal接收mariaDB推送**
1. canal已经搭建完毕，数据接收代码也已经初步测试完成
#### **canal同步数据到es** 
1. 采用配置式开发，通用代码逻辑已经完成
2. 主要解决的是多表同步问题（单表canal自己就能解决）
##### **具体思路**
当数据库指定多表关联关系的表被更新，canal会同步更新表，本服务会接收到单表更新数据，进行数据库多表联查（条件是单表的ID），查出数据之后进行es存储

##### **配置文件**
1. 配置相应的多表联查**dao类方法**
  这个方法是要通过反射获取执行的
  ps：方法必须有参数为结果集类 返回值必须是结果集类的集合 书写的sql语句必须有**where条件** 取出结果集类相应更新单表的ID 必须增加**limit** 某个数值 太多数据服务器承受不住（不这样写每次都全查百万条数据太要命 估计服务器就崩了）
2. 配置相应的多表联查**结果集类** 
  这个类用来反射存储更新类的数据 也是dao多表联查的返回值
  ps：有个类是castUtil 如果这个类字段**不是string**类型 麻烦在里面添加一条类型转换 现在已有类型转换bigdecmical 、int    
3. 配置相应的多表联查**dao类**
  这个类通过反射获取 调用dao类方法 返回结果集
  ps：这个dao类类似于mybatis配置 xml文件也要写 方法名dao类的方法对应  在启动类配置相应的**包扫描**
4. 配置相应的多表联查**es类**（用于存储到es）
  这是将数据存储到es的类 这个类默认调用saveAll的方法存储所有的结果集到es
  ps：这个创建好实现**ElasticsearchRepository**接口  在启动类配置相应的包扫描 

##### **实现逻辑**

​	        0.读取配置文件
​	        1.通过反射获取相应的 **类 和dao类和es类** 对象
​                2. canal会传输相应的 类的**修改后**数据信息
​                3. 反射类的**set**方法为**类对象** 设置对应的字段
​                4. 反射dao类的**sqlMethod方法** 查询数据更新信息 封装到类对象
​                5. 反射es类相应的**saveAll方法** 存储

```yaml
#这是缓存的类名 这个不要改
tableName:
#这是单表改变的类（需要配置 这个可以配置多个）
    arc_ownerinfo:
#这是多表联查调用的方法 （需要配置 -再加个-可以再写一套 每个单表更改 可定能有多个多表结果集变化）  
        - sqlMethod: 'selectAllBySubAccount'
#这是结果集类  （需要配置）   
          className: com.wangshiyang#这是dao类  （需要配置）  
          wangshiyang
#这是es同步类 （需要配置）    
          wangshiyang
```

​	所有配置方法服务中已经有Demo 直接对应配置即可




